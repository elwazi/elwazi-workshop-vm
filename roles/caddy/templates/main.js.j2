/* ── User data from Ansible template ──────────────── */
var userData = {
{% for server in groups["workshop_servers"] %}
{% for user in hostvars[server].workshop_users %}
    "{{ user.username }}": "{{ hostvars[server].inventory_hostname_short }}",
{% endfor %}
{% endfor %}
};

var domain = "{{ domain_name }}";

/* ── User selector ────────────────────────────────── */
document.getElementById("user-select").addEventListener("change", function () {
    var username = this.value;
    var details = document.getElementById("connection-details");
    if (!username) {
        details.classList.remove("visible");
        /* Reset dynamic placeholders */
        document.querySelectorAll(".dyn-user").forEach(function (el) { el.textContent = "username"; el.classList.remove("filled"); });
        document.querySelectorAll(".dyn-server").forEach(function (el) { el.textContent = "server"; el.classList.remove("filled"); });
        return;
    }
    var server = userData[username];
    details.classList.add("visible");

    document.getElementById("ssh-cmd").textContent =
        "ssh -J " + username + "@" + domain + " " + username + "@" + server;
{% if jupyter_install %}
    document.getElementById("jupyter-url").innerHTML =
        '<a href="https://' + domain + '/' + server + '/jupyter/" target="_blank">https://' + domain + '/' + server + '/jupyter/</a>';
{% endif %}
{% if rstudio_install %}
    document.getElementById("rstudio-url").innerHTML =
        '<a href="https://' + domain + '/' + server + '/rstudio/" target="_blank">https://' + domain + '/' + server + '/rstudio/</a>';
{% endif %}

    /* Update dynamic placeholders in tab content */
    document.querySelectorAll(".dyn-user").forEach(function (el) { el.textContent = username; el.classList.add("filled"); });
    document.querySelectorAll(".dyn-server").forEach(function (el) { el.textContent = server; el.classList.add("filled"); });
});

/* ── Copy to clipboard ────────────────────────────── */
document.addEventListener("click", function (e) {
    if (e.target.tagName === "A") return;
    var el = e.target.closest(".conn-value");
    if (!el) return;
    var text = el.textContent;
    if (!navigator.clipboard) return;
    navigator.clipboard.writeText(text).then(function () {
        el.classList.add("copied");
        setTimeout(function () { el.classList.remove("copied"); }, 1500);
    });
});

/* ── Tab switching ────────────────────────────────── */
document.querySelectorAll(".tab-btn").forEach(function (btn) {
    btn.addEventListener("click", function () {
        var tab = this.getAttribute("data-tab");

        document.querySelectorAll(".tab-btn").forEach(function (b) {
            b.classList.remove("active");
            b.setAttribute("aria-selected", "false");
        });
        this.classList.add("active");
        this.setAttribute("aria-selected", "true");

        document.querySelectorAll(".tab-panel").forEach(function (p) {
            p.classList.remove("active");
        });
        var panel = document.getElementById("panel-" + tab);
        if (panel) panel.classList.add("active");
    });
});
